<!DOCTYPE html>
<html lang="en">
<head>
    <script src="jquery.min.js"></script>
    <script src="signalr.min.js"></script>
    <script>
        $(document).ready(function () {

            // Create and configure the SignalR connection
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("https://localhost:7080/myhub")
                .withAutomaticReconnect([1000,2000,3000])
                .build();

            // Function to start the SignalR connection with retry logic
            async function startConnection() {
                try {
                    await connection.start();
                    console.log("SignalR connection successful!");
                } catch (error) {
                    console.error(`Connection failed: ${error}`);
                    setTimeout(startConnection, 2000); // Retry connection after 2 seconds
                }
            }

            
            function animation(){
                connectionStatus.fadeIn(2000,() =>{
                    setTimeout(() =>{
                         connectionStatus.fadeOut(2000);
                    },2000)
                })
            }

            startConnection(); // Start the connection

            const connectionStatus = $('#connectionStatus');


            connection.onreconnecting(error =>{
                connectionStatus.css("background-color","blue");
                connectionStatus.css("color","white");
                connectionStatus.html("Establishing Connection")
                animation();
            });

            connection.onreconnected(connectionId =>{
                connectionStatus.css("background-color","yellow");
                connectionStatus.css("color","black");
                connectionStatus.html("Connection")
                animation();

            });

            connection.onclose(connectionId =>{
                connectionStatus.css("background-color","red");
                connectionStatus.css("color","white");
                connectionStatus.html("Connection Failed")
                animation();

            })
              
            connection.on("userJoined",connectionId =>{
                connectionStatus.html(`${connectionId} connected`)
                connectionStatus.css("backgorund-color","green");
                animation();

            });

            connection.on("userLeaved",connectionId =>{
                connectionStatus.html(`${connectionId} leaved`)
                connectionStatus.css("backgorund-color","red")
                animation();

            });

            connection.on("clients",data =>{
                let text = "";
                $.each(data,(index,item) =>{
                    text += `<li>${item}</li>` 
                    $("#clients").html(text)
                });
            })

            // Event handler for receiving messages
            connection.on("receiveMessage", message => {
                displayMessage(message);
            });
          
            // Function to display received messages
            function displayMessage(message) {
                $("#messagesContainer").append(`${message}<br>`);
            }

            // Event handler for the send button click
            $("#sendButton").click(sendMessage);

            // Function to send a message to the server
            function sendMessage() {
                const message = $('#userInput').val().trim();

                if (!message) {
                    console.log("Message cannot be empty!");
                    return;
                }

                connection.invoke("SendMessageAsync", message)
                    .then(() => {
                        console.log("Message sent successfully.");
                        $('#userInput').val(''); // Clear the input field
                    })
                    .catch(error => {
                        console.error(`Error sending message: ${error}`);
                    });
            }

        });
    </script>
</head>
<body>
    <div id="connectionStatus" style="display: none;"></div>
    <input type="text" id="userInput" placeholder="Type your message here">
    <button id="sendButton">Send</button>
    <div id="messagesContainer"></div>

    <div>
        <ul id="clients"></ul>
    </div>
</body>
</html>
